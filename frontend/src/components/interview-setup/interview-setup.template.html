<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card interview-setup-card">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Interview Setup
                    </h4>
                </div>
                <div class="card-body p-4">
                    <!-- Error Alert -->
                    <div ng-if="vm.error" class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{vm.error}}
                    </div>

                    <!-- Practice Session Info -->
                    <div ng-if="vm.isPracticeSession" class="alert alert-info mb-4">
                        <h5 class="mb-3">
                            <i class="fas fa-redo me-2"></i>
                            Practice Session Setup
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong>Original Session:</strong> {{vm.originalDifficulty}} difficulty
                                </p>
                                <p class="mb-2">
                                    <strong>Recommended:</strong> 
                                    <span class="badge bg-primary">{{vm.recommendedDifficulty}}</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-0">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {{vm.difficultyReason}}
                                    </small>
                                </p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                We've pre-selected the recommended difficulty, but you can change it below if you prefer.
                            </small>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Left Column - Form Fields -->
                        <div class="col-md-6">
                            <form ng-submit="vm.startInterview()">
                                <!-- Enhanced Role Selection -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Target Role *</label>
                                    <role-selector 
                                        selected-role="vm.config.selectedRole"
                                        on-role-change="vm.onRoleChange(role)"
                                        required="true"
                                        show-tech-stack="true">
                                    </role-selector>
                                    
                                    <!-- Role Selection Warning for Quick Test -->
                                    <div ng-if="!vm.config.selectedRole && !vm.config.target_role" class="alert alert-warning py-2 mt-2">
                                        <small>
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <strong>Quick Test:</strong> Please select a role to start a quick test with relevant questions.
                                        </small>
                                    </div>
                                    
                                    <!-- Backward Compatibility Fallback -->
                                    <div ng-if="vm.showLegacyRoleSelector" class="mt-2">
                                        <label for="targetRole" class="form-label">Or select from basic roles:</label>
                                        <select id="targetRole" class="form-select" ng-model="vm.config.target_role">
                                            <option value="">Select a role...</option>
                                            <option value="Marketing Manager">Marketing Manager</option>
                                            <option value="Software Engineer">Software Engineer</option>
                                            <option value="Product Manager">Product Manager</option>
                                            <option value="Data Scientist">Data Scientist</option>
                                            <option value="Sales Representative">Sales Representative</option>
                                            <option value="Business Analyst">Business Analyst</option>
                                            <option value="Project Manager">Project Manager</option>
                                            <option value="UX Designer">UX Designer</option>
                                        </select>
                                        <small class="text-muted">
                                            <button type="button" class="btn btn-link btn-sm p-0" ng-click="vm.showLegacyRoleSelector = false">
                                                Use enhanced role selector
                                            </button>
                                        </small>
                                    </div>
                                    
                                    <div ng-if="!vm.showLegacyRoleSelector" class="mt-2">
                                        <small class="text-muted">
                                            <button type="button" class="btn btn-link btn-sm p-0" ng-click="vm.showLegacyRoleSelector = true">
                                                Use simple role selector
                                            </button>
                                        </small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="interviewType" class="form-label fw-bold">Interview Type</label>
                                    <select id="interviewType" class="form-select" ng-model="vm.config.session_type" required>
                                        <option value="">Select type...</option>
                                        <option value="mixed">Mixed Interview</option>
                                        <option value="behavioral">Behavioral Questions</option>
                                        <option value="technical">Technical Questions</option>
                                        <option value="hr">HR</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="difficultyLevel" class="form-label fw-bold">Difficulty Level</label>
                                    
                                    <!-- Practice Session Difficulty Info -->
                                    <div ng-if="vm.isPracticeSession" class="alert alert-success py-2 mb-2">
                                        <small>
                                            <i class="fas fa-robot me-1"></i>
                                            <strong>Adaptive Recommendation:</strong> {{ vm.recommendedDifficulty }}
                                            <br>
                                            <span class="text-muted">Based on your performance in the previous session</span>
                                        </small>
                                    </div>
                                    
                                    <!-- Regular Session Difficulty Recommendation -->
                                    <div ng-if="!vm.isPracticeSession && vm.recommendedDifficulty" class="alert alert-info py-2 mb-2">
                                        <small>
                                            <i class="fas fa-lightbulb me-1"></i>
                                            <strong>Recommended:</strong> {{ vm.recommendedDifficulty }} 
                                            <span ng-if="vm.difficultyReason">({{ vm.difficultyReason }})</span>
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" 
                                                    ng-click="vm.config.difficulty = vm.recommendedDifficulty">
                                                Use Recommended
                                            </button>
                                        </small>
                                    </div>
                                    
                                    <select id="difficultyLevel" class="form-select" ng-model="vm.config.difficulty" required>
                                        <option value="">Select difficulty...</option>
                                        <option value="easy">Easy</option>
                                        <option value="medium">Medium</option>
                                        <option value="hard">Hard</option>
                                        <option value="expert">Expert</option>
                                    </select>
                                    
                                    <!-- Current Level Display for Regular Sessions -->
                                    <div ng-if="!vm.isPracticeSession && vm.currentDifficulty" class="mt-1">
                                        <small class="text-muted">
                                            <i class="fas fa-flag me-1"></i>
                                            Your current level: <span class="fw-bold">{{ vm.currentDifficulty }}</span>
                                        </small>
                                    </div>
                                    
                                    <!-- Original vs Recommended for Practice Sessions -->
                                    <div ng-if="vm.isPracticeSession && vm.originalDifficulty" class="mt-1">
                                        <small class="text-muted">
                                            <i class="fas fa-history me-1"></i>
                                            Previous session: <span class="fw-bold">{{ vm.originalDifficulty }}</span>
                                            <span ng-if="vm.originalDifficulty !== vm.recommendedDifficulty">
                                                â†’ <span class="fw-bold text-primary">{{ vm.recommendedDifficulty }}</span> (recommended)
                                            </span>
                                        </small>
                                    </div>
                                </div>

                                <!-- Duration and Question Count -->
                                <div class="row mb-4">
                                    <div class="col-6">
                                        <label for="duration" class="form-label fw-bold">Duration (minutes)</label>
                                        <input id="duration" type="number" class="form-control" ng-model="vm.config.duration" min="5" max="120">
                                    </div>
                                    <div class="col-6">
                                        <label for="questionCount" class="form-label fw-bold">Number of Questions</label>
                                        <input id="questionCount" type="number" class="form-control" ng-model="vm.config.question_count" min="1" max="20">
                                    </div>
                                </div>

                                <!-- Quick Test Settings Info -->
                                <div ng-if="vm.showQuickTestInfo" class="alert alert-success mb-3">
                                    <h6 class="mb-2">
                                        <i class="fas fa-bolt me-2"></i>
                                        Quick Test Settings
                                        <span class="badge bg-primary ms-2">Recommended</span>
                                    </h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small>
                                                <strong>Question Count:</strong> 
                                                <span ng-if="vm.quickTestSettings.question_count_source === 'inherited'">
                                                    {{vm.quickTestSettings.question_count}} (from your preferences)
                                                </span>
                                                <span ng-if="vm.quickTestSettings.question_count_source === 'default'">
                                                    {{vm.quickTestSettings.question_count}} (default for new users)
                                                </span>
                                                <span ng-if="vm.quickTestSettings.question_count_source === 'user_override'">
                                                    {{vm.quickTestSettings.question_count}} (custom)
                                                </span>
                                            </small>
                                        </div>
                                        <div class="col-6">
                                            <small>
                                                <strong>Duration:</strong> 
                                                <span ng-if="vm.customOverrideSettings && vm.customOverrideSettings.duration">
                                                    {{vm.customOverrideSettings.duration}} minutes (custom)
                                                </span>
                                                <span ng-if="!vm.customOverrideSettings || !vm.customOverrideSettings.duration">
                                                    15 minutes (fixed)
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small>
                                                <strong>Difficulty:</strong> 
                                                <span ng-if="vm.customOverrideSettings && vm.customOverrideSettings.difficulty">
                                                    {{vm.customOverrideSettings.difficulty | capitalize}} (custom)
                                                </span>
                                                <span ng-if="!vm.customOverrideSettings || !vm.customOverrideSettings.difficulty">
                                                    {{vm.quickTestSettings.difficulty || 'Medium'}} (recommended)
                                                </span>
                                            </small>
                                        </div>
                                        <div class="col-6">
                                            <small>
                                                <strong>Role:</strong> 
                                                <span ng-if="vm.config.selectedRole">
                                                    {{vm.config.selectedRole.displayName || vm.config.selectedRole.mainRole}}
                                                </span>
                                                <span ng-if="!vm.config.selectedRole && vm.config.target_role">
                                                    {{vm.config.target_role}}
                                                </span>
                                                <span ng-if="!vm.config.selectedRole && !vm.config.target_role" class="text-warning">
                                                    Not selected
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small>
                                            <strong>Question Types:</strong> 
                                            <span ng-if="vm.quickTestSettings.distribution_summary">
                                                {{vm.quickTestSettings.distribution_summary}}
                                            </span>
                                            <span ng-if="!vm.quickTestSettings.distribution_summary">
                                                Balanced mix of theory, coding, and aptitude questions
                                            </span>
                                        </small>
                                    </div>
                                    
                                    <!-- Quick Test Customization Form -->
                                    <div ng-if="vm.showQuickTestCustomization" class="mt-3 p-3 border rounded bg-light">
                                        <h6 class="mb-3">Customize Quick Test</h6>
                                        <div class="row">
                                            <div class="col-3">
                                                <label class="form-label">Question Count</label>
                                                <select class="form-select form-select-sm" ng-model="vm.customQuickTestSettings.question_count" title="Select number of questions for quick test">
                                                    <option value="3">3 questions</option>
                                                    <option value="5">5 questions</option>
                                                    <option value="7">7 questions</option>
                                                    <option value="10">10 questions</option>
                                                </select>
                                            </div>
                                            <div class="col-3">
                                                <label class="form-label">Difficulty</label>
                                                <select class="form-select form-select-sm" ng-model="vm.customQuickTestSettings.difficulty" title="Select difficulty level for quick test">
                                                    <option value="easy">Easy</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="hard">Hard</option>
                                                    <option value="expert">Expert</option>
                                                </select>
                                            </div>
                                            <div class="col-3">
                                                <label class="form-label">Duration (minutes)</label>
                                                <select class="form-select form-select-sm" ng-model="vm.customQuickTestSettings.duration" title="Select duration for quick test">
                                                    <option value="5">5 minutes</option>
                                                    <option value="10">10 minutes</option>
                                                    <option value="15">15 minutes</option>
                                                    <option value="20">20 minutes</option>
                                                    <option value="30">30 minutes</option>
                                                    <option value="45">45 minutes</option>
                                                    <option value="60">60 minutes</option>
                                                </select>
                                            </div>
                                            <div class="col-3">
                                                <label class="form-label">Actions</label>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-success me-1" ng-click="vm.applyCustomSettings()">
                                                        Apply
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-secondary" ng-click="vm.showQuickTestCustomization = false">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" ng-click="vm.customizeQuickTest()">
                                            <i class="fas fa-cog me-1"></i>
                                            {{vm.showQuickTestCustomization ? 'Hide' : 'Customize'}} Settings
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success ms-1" ng-click="vm.applyMainFormToQuickTest()" title="Use your main form settings for Quick Test">
                                            <i class="fas fa-sync me-1"></i>
                                            Use Main Form Settings
                                        </button>
                                        <button type="button" class="btn btn-sm btn-link ms-1" ng-click="vm.showQuickTestInfo = false">
                                            Hide Details
                                        </button>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-flex gap-2 mb-3">
                                    <button type="button" class="btn btn-secondary" ng-click="vm.goToDashboard()">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Back to Dashboard
                                    </button>
                                    <button type="button" class="btn btn-success" 
                                            ng-click="vm.startTest()"
                                            ng-disabled="!vm.config.selectedRole && !vm.config.target_role"
                                            title="{{(!vm.config.selectedRole && !vm.config.target_role) ? 'Please select a role first' : 'Start a quick test with recommended settings'}}">
                                        <i class="fas fa-play me-2"></i>
                                        Quick Test
                                        <span ng-if="!vm.showQuickTestInfo" class="ms-1">
                                            <i class="fas fa-info-circle" ng-click="vm.showQuickTestInfo = true; $event.stopPropagation()"></i>
                                        </span>
                                    </button>
                                    <button type="submit" class="btn btn-primary" ng-disabled="vm.loading || !vm.cameraReady">
                                        <span ng-if="vm.loading">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            <span ng-if="vm.isPracticeSession">Starting Practice...</span>
                                            <span ng-if="!vm.isPracticeSession">Starting...</span>
                                        </span>
                                        <span ng-if="!vm.loading">
                                            <i class="fas fa-video me-2"></i>
                                            <span ng-if="vm.isPracticeSession">Start Practice Session</span>
                                            <span ng-if="!vm.isPracticeSession">Start Interview</span>
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Right Column - Camera Preview -->
                        <div class="col-md-6">
                            <div>
                                <label class="form-label fw-bold">Camera Preview</label>
                                <div class="camera-preview-container">
                                    <div class="camera-preview-box border rounded overflow-hidden mb-3" style="height: 300px; background: #f8f9fa;">
                                        <video id="setupPreviewVideo" class="w-100 h-100" autoplay muted ng-show="vm.cameraActive" style="object-fit: cover;"></video>
                                        
                                        <!-- Camera Error State -->
                                        <div ng-if="vm.cameraError" class="d-flex align-items-center justify-content-center h-100 text-center">
                                            <div>
                                                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                                <p class="text-muted">{{vm.cameraError}}</p>
                                                <button class="btn btn-sm btn-outline-primary" ng-click="vm.startCamera()">
                                                    <i class="fas fa-redo me-1"></i>
                                                    Retry
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Camera Loading State -->
                                        <div ng-if="!vm.cameraActive && !vm.cameraError" class="d-flex align-items-center justify-content-center h-100">
                                            <div class="text-center">
                                                <i class="fas fa-video fa-3x text-muted mb-3"></i>
                                                <p class="text-muted">Initializing camera...</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Camera Status -->
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <span class="badge me-2" ng-class="vm.cameraActive ? 'bg-success' : 'bg-secondary'">
                                                <i class="fas fa-video me-1"></i>
                                                {{vm.cameraActive ? 'Camera Ready' : 'Camera Off'}}
                                            </span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary" ng-click="vm.cameraActive ? vm.stopCamera() : vm.startCamera()">
                                            <i class="fas" ng-class="vm.cameraActive ? 'fa-stop' : 'fa-play'"></i>
                                            {{vm.cameraActive ? 'Stop' : 'Start'}}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>