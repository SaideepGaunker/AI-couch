<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>üß™ Gemini API Integration Test</h2>
        <p>This page tests if the Gemini API is working correctly in your application.</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>API Status Tests</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testGeminiDebug()">Test Gemini Debug Endpoint</button>
                        <button class="btn btn-secondary ms-2" onclick="testQuestionGeneration()">Test Question Generation</button>
                        <button class="btn btn-info ms-2" onclick="testInterviewStart()">Test Interview Start</button>
                        
                        <div id="test-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Generated Questions</h5>
                    </div>
                    <div class="card-body">
                        <div id="questions-display">
                            <p class="text-muted">Click "Test Question Generation" to see generated questions</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Logs</h5>
                    </div>
                    <div class="card-body">
                        <pre id="test-logs" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 10px;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let authToken = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-logs');
            const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
            logElement.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showResult(title, success, message, details = null) {
            const resultsDiv = document.getElementById('test-results');
            const resultClass = success ? 'success' : 'error';
            const statusClass = success ? 'status-success' : 'status-error';
            
            const resultHtml = `
                <div class="test-result ${resultClass}">
                    <strong class="${statusClass}">${success ? '‚úÖ' : '‚ùå'} ${title}</strong>
                    <p>${message}</p>
                    ${details ? `<small><pre>${JSON.stringify(details, null, 2)}</pre></small>` : ''}
                </div>
            `;
            
            resultsDiv.innerHTML += resultHtml;
        }

        async function getAuthToken() {
            if (authToken) return authToken;
            
            try {
                log('Getting authentication token...');
                
                // Try to login with test credentials
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'testpassword'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    log('‚úÖ Authentication successful', 'success');
                    return authToken;
                } else {
                    log('‚ö†Ô∏è Login failed, trying to register test user...', 'warning');
                    
                    // Try to register test user
                    const registerResponse = await fetch(`${API_BASE}/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: 'test@example.com',
                            password: 'testpassword',
                            full_name: 'Test User'
                        })
                    });

                    if (registerResponse.ok) {
                        log('‚úÖ Test user registered, logging in...', 'success');
                        return await getAuthToken(); // Retry login
                    } else {
                        throw new Error('Failed to register test user');
                    }
                }
            } catch (error) {
                log(`‚ùå Authentication failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testGeminiDebug() {
            log('Testing Gemini debug endpoint...');
            
            try {
                const token = await getAuthToken();
                
                const response = await fetch(`${API_BASE}/debug/gemini`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showResult('Gemini Debug Test', true, 'Gemini API is working correctly!', data);
                    log('‚úÖ Gemini API debug test passed', 'success');
                } else {
                    showResult('Gemini Debug Test', false, `Gemini API issue: ${data.message}`, data);
                    log(`‚ùå Gemini API debug test failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('Gemini Debug Test', false, `Test failed: ${error.message}`);
                log(`‚ùå Gemini debug test error: ${error.message}`, 'error');
            }
        }

        async function testQuestionGeneration() {
            log('Testing question generation...');
            
            try {
                const token = await getAuthToken();
                
                const response = await fetch(`${API_BASE}/questions/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role: 'Python Developer',
                        difficulty: 'intermediate',
                        question_type: 'mixed',
                        count: 3
                    })
                });

                if (response.ok) {
                    const questions = await response.json();
                    showResult('Question Generation', true, `Generated ${questions.length} questions successfully!`);
                    log(`‚úÖ Generated ${questions.length} questions`, 'success');
                    
                    // Display questions
                    const questionsDiv = document.getElementById('questions-display');
                    let questionsHtml = '<h6>Generated Questions:</h6>';
                    questions.forEach((q, i) => {
                        questionsHtml += `
                            <div class="mb-2 p-2 border rounded">
                                <strong>Q${i + 1}:</strong> ${q.content}<br>
                                <small class="text-muted">Type: ${q.question_type} | Difficulty: ${q.difficulty_level} | Duration: ${q.expected_duration}min</small>
                            </div>
                        `;
                    });
                    questionsDiv.innerHTML = questionsHtml;
                } else {
                    const error = await response.json();
                    showResult('Question Generation', false, `Failed to generate questions: ${error.detail}`);
                    log(`‚ùå Question generation failed: ${error.detail}`, 'error');
                }
            } catch (error) {
                showResult('Question Generation', false, `Test failed: ${error.message}`);
                log(`‚ùå Question generation error: ${error.message}`, 'error');
            }
        }

        async function testInterviewStart() {
            log('Testing interview session start...');
            
            try {
                const token = await getAuthToken();
                
                const response = await fetch(`${API_BASE}/interviews/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_role: 'Python Developer',
                        difficulty: 'intermediate',
                        session_type: 'practice',
                        question_count: 3
                    })
                });

                if (response.ok) {
                    const session = await response.json();
                    showResult('Interview Start', true, `Interview session started successfully! Session ID: ${session.session_id}`, session);
                    log(`‚úÖ Interview session ${session.session_id} started`, 'success');
                } else {
                    const error = await response.json();
                    showResult('Interview Start', false, `Failed to start interview: ${error.detail}`);
                    log(`‚ùå Interview start failed: ${error.detail}`, 'error');
                }
            } catch (error) {
                showResult('Interview Start', false, `Test failed: ${error.message}`);
                log(`‚ùå Interview start error: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üß™ Gemini API Test Page Loaded');
            log('Click the test buttons to verify your Gemini API integration');
        });
    </script>
</body>
</html>